### 4.1 加密、身份验证与完整性
> - 加密：混淆数据的机制
> - 身份验证：验证身份标识有效性的机制
> - 完整性：检测消息是否被篡改或者伪造的机制

### 4.2 TLS握手
> ![image](https://raw.githubusercontent.com/weikano/NoteResources/master/WEB-Guide/4.png) 
> - 0ms：TLS在TCP上运行，意味着需要完成TCP的三次握手，即一次完整的往返
> - 56ms：TCP连接建立后，客户端再以纯文本发送一些规格说明，比如TLS协议版本号、支持的加密套件列表以及一些其他的TLS选项
> - 84ms：服务器取得TLS协议版本以备将来通信使用，从客户端提供的加密套件列表中选择一个，再附上自己的证书，以响应发回给客户端。作为可选项，服务器也可以发送一个请求，要求客户端提供证书以及其他TLS扩展参数
> - 112ms：假设两端经过协商后确定了共同的版本和加密套件，客户端也提供了自己的证书给服务器。然后客户端会生成一个新的对称秘钥，用服务器的公钥加密，然后发送给服务器。**到现在为止，所有的通信都是明文**
> - 140ms：服务器解密客户端发来的对称秘钥，通过验证消息的MAC检测消息完整性，再返回给客户端一个加密的"Finish"消息
> - 168ms：客户端用它之前生成的堆成秘钥解密这条消息，验证MAC，如果一切顺利，则建立信道并开始发送应用数据

#### 4.2.1 应用层协议协商（ALPN）
> - 客户端在ClientHello消息中追加一个新的ProtocalNameList字段，包含自己支持的应用协议
> - 服务器检查ProtocalNameList字段，并在ServerHello中以ProtocalName返回选中的协议
#### 4.2.2 服务器名称指示

### 4.3 TLS会话恢复
#### 4.3.1 会话标识符
> 会话标识符会在TLS协商期间作为ServerHello消息的一部分发送。服务器会为每个客户端保存一个会话ID和协商后的会话参数。相应的，客户端也可以保存会话ID信息，并将该ID信息包含在ClientHello消息中，从而告诉服务器自己还记得上次握手协商后的加密套机及秘钥，这些都可以重用，从而进行**简短握手**
> ![image](https://raw.githubusercontent.com/weikano/NoteResources/master/WEB-Guide/5.png)

#### 4.3.2 会话记录单
> 如果客户端明确表示支持会话记录单，那么服务器在完整TLS握手的最后一次交换中添加一条新会话记录单记录，包含只有服务器知道的安全加密过的所有会话数据，然后客户端会将这个记录保存起来，在后续会话的ClientHello中将其包含在SessionTicket扩展中。这样所有的会话数据只保存在客户端，而且因为加密过且秘钥只要服务器知道，因此仍然是安全的

### 4.4 信任链与证书办法机构
### 4.5 证书撤销
#### 4.5.1 证书撤销名单（CRL）
#### 4.5.2 在线证书状态（OCSP）

### 4.6 TLS记录协议
### 4.7 针对TLS的优化建议
#### 4.7.1 计算成本
> 首先由一个非对称加密，然后在握手期间确定共享密钥，作为对后续TLS记录加密的对称密钥
#### 4.7.2 尽早完成握手
> 建立连接的延迟体现在每个TLS连接上，包括新连接和恢复的连接，因此是优化的重点
>
> TCP首先要经过三次握手，两端要通过一次完整的往返交换SYN/SYN-ACK分组。其次，TLS握手在完整情况下要进行两次额外的往返，在简短情况下需要一次额外的往返
>
> 所有TCP优化都可以应用在此
#### 4.7.3 会话缓存和无状态恢复
> - 支持多进程或工作进程的服务器应该使用共享的会话缓存
> - 共享的会话缓存大小应该根据流量调整
> - 设置会话超时时间
> - 多台服务器并存的情况下，把相同的客户端IP或相同的TLS会话ID路由到同一台机器可以更好的利用会话缓存
> - 检查和监控TLS会话缓存的使用情况
#### 4.7.4 TLS记录大小
#### 4.7.5 TLS压缩
> 压缩算法在TLS握手期间商定，压缩在对记录加密之前执行。但是双重压缩会浪费客户端和服务器的时间（比如再次压缩已经压缩过的图像视频等），还会暴露安全漏洞
#### 4.7.6 证书链的长度
> - 缩短证书链长度
> - 如果证书链长度超过TCP的初始拥塞窗口，会让握手多一次往返
#### 4.7.7 OCSP封套
#### 4.7.8 HTTP严格传输安全（HSTS）
### 4.8 性能检查清单
> - 提升TCP性能
> - 升级TLS到最新版本
> - 启用会话缓存和无状态恢复
> - 服务器距离缩短，减少往返延迟
> - 配置TLS记录大小，使其恰好能封装在一个TCP段内
> - 确保证书链不会超过拥塞窗口大小
> - 从信任链中去掉不必要的证书，减少链条层次
> - 禁止TLS压缩
> - 启用SNI支持
> - 启用OCSP
> - 追加HTTP严格传输安全首部





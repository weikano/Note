## IP：网际协议

### 1、引言

IP提供不可靠、无连接的数据报传送服务。

- 不可靠：不能保证IP数据报能成功的到达目的地。IP仅提供最好的传输服务。如果发生某种错误，比如某个路由器暂时用完了缓冲区，IP有一个简单的错误处理算法：丢弃该数据，然后发送ICMP消息报给信源端。任何要求的可靠性必须由上层提供（TCP）。
- 无连接：IP并不维护任何关于后续数据报的状态信息。每个数据报的处理都是独立的。即IP数据报可以不按发送顺序接收。如果一个信源发送两个连续的数据报（A、B），每个数据报都是独立地进行路由选择，肯呢个选择不同的路线，因此B可能在A到达之前先到达。

### 2、IP首部

普通的IP首部长为20个字节（20 byte），除非含有选项字段。

![image](https://raw.githubusercontent.com/weikano/NoteResources/master/TCP%26IP/003.png)

目前的协议版本号是4，所以简称为IPv4。

首部长度字段表示了IP头部的总长度，但它不是直接表示，因为它只占了4 bit，最大也就15，实际的IP头部长度等于首部长度字段表示的值乘以4，单位是字节，也就是首部长度最长为15*4=60字节。一般IP数据报都没有选择项，长度为20字节，也就是首部长度字段中的值为5。

总长度表示了数据报的总长度，占用了16 bit。它对应的值直接表示了数据报总长度（最大为2^16-1）。

总长度字段是IP首部中的必要内容。因为一些数据链路需要填充一些数据以打到最小长度。尽管以太网的最小帧长为46字节，但是IP数据可能会更短。如果没有总长度，那么IP层就不知道46字节中有多少是IP数据报的内容。

### 3、IP路由选择

如果目的主机与源主机直接相连（如点对点链路）或都在一个共享网络上（以太网或令牌环网），那么IP数据报直接送到目的主机。否则主机把数据报发往一默认的路由器上，由路由器转发该数据报。

IP层在内存中有一个路由表。当收到一份数据报并进行发送时，它都要对该表搜索一次。当数据报来自某个网络接口时，IP首先检查目的IP地址是否为本机的IP地址之一或者IP广播地址。如果确实是这样，数据报就送到由IP首部协议字段所指定的协议模块进行处理。如果数据报目的地不是这些地址，那么如果IP层被设置为路由器的功能，那么就对数据报进行转发，否则就丢弃该数据报。

路由表中的每一项都包含以下信息：

- 目的IP地址。可以是一个完整的主机地址 ，也可以是一个网络地址，由该表目中的标志字段来指定。
- 下一站（下一跳）路由器的IP地址，或者有直接连接的网络IP地址。下一站路由器是指一个在直接相连网络上的路由器，通过它可以转发数据。非最终目的，但是它可以把传送给它的数据报转发到最终目的。
- 标志。其中一个标志指明目的IP是网络地址还是主机地址，另一个知名下一站路由器是否为真正的下一站路由器，还是一个直接相连的接口。
- 为数据报的传输指定一个网络接口。

IP路由选择是逐跳进行（hop-by-hop）。IP并不知道到达目的地的完整路径（除了与主机直接相连的目的）。所有的IP路由选择只为数据报传输提供下一站路由器的IP地址。它假定下一站路由器比数据报的主机更接近目的，而且下一站路由器与该主机是直接相连的。

IP路由选择主要完成以下这些功能：

1. 搜索路由表，寻找能与目的IP地址匹配的标目（网络号和主机号都要匹配）。如果找到，则把报文发送给该标目指定的下一站路由器或直接链接的网络接口（取决于标志字段的值）。
2. 搜索路由表，寻找能与目的网络号匹配的标目。如果找到，发送报文给该标目指定的下一站路由器或直接连接的网络接口（取决于标志字段的值）。目的网络上的所有主机都可以通过这个表目来处置。这种搜索网络的方式要考虑子网掩码。
3. 搜索路由表，寻找标为“默认(default)”的表目。如果找到，则把报文发送给该标目指定的下一站路由器。

如果上述步骤都失败，数据报就不能被传送。如果不能传送的数据报来自本机，那么一般会向生成数据报的应用程序返回一个“主机不可达”或“网络不可达”的错误。

完整主机地址匹配在网络号匹配之前执行。只有当它们都失败时才选择默认路由。

### 4、子网寻址 TODO

### 5、子网掩码

大多数系统把IP地址存在一个磁盘文件里供引导时读用。

假设我们的主机地址是140.252.1.1，而子网掩码为255.255.255.0：

- 如果目的IP地址是140.252.4.5，那么我们就知道B类网络号是相同的（140.252），但是子网号不相同（1和4）。
- 如果目的IP地址是140.252.1.2，那么网络号相同且子网号相同，但是主机号不同。
- 如果目的IP地址是192.43.235.6（C类地址），那么网络号不同。

**子网掩码是用来判断任意两台计算机的IP地址是否属于同一子网络。最为简单的理解就是两台计算机各自的IP地址与子网掩码进行AND运算后，如果得出的结果是相同的，则说明这两台计算机是处于同一个子网络上的，可以进行直接的通讯。**


### 第3章-网络：性能优化中的不可控因素

#### 3.1 原理

优化网络性能无非三个方面：业务成功率、业务网络延时、带宽成本。

**业务成功率**

- 弱信号：简单看成当手机信号只有一两格的时候，不仅仅是信令发出去困难，而且可能导致不断地切换网络、切换基站。app能做的就是在app层进行重试。
- 拥塞网络：数据包排队、信令排队。app能做的是让自己的非核心业务不要排队，让核心业务数据量更少，协议来回更少。

**业务网络延时**

- DNS解析：10分钟的DNSCache过期时间，200~2000ms不等的dns解析时间。解决方案有IP直连、域名重用以及HttpDNS。
- 建立连接：大多数都是基于TCP的长连接，需要通过心跳维持。**如果长连接心跳间隔等于移动网络状态机Active-Idle切换间隔时，会造成信令风暴；如果心跳包过少，会造成NAT超时，导致长连接断开**。接收窗口大小的协商用于拥塞控制：服务器的ReceiveBuffer太小；慢启动+包太小；Window size scaling factor失效等。

**业务带宽成本**

节省成本策略：压缩、去重、增量

压缩

> 1. 图片用webp压缩、png压缩，还可以用progressive JPEG的不同程度压缩替代大中小图，视频用h264、h265压缩，文本gzip和其他zip方案。
> 2. 图片的尺寸在不同分辨率的屏幕要下载不同的尺寸；webp的解码和编码对于CPU的消耗时JPEG的3倍以上，建议解码后在本地保存为JPEG。
> 3. 增量会使协议和业务的实现更复杂
> 4. 去重。避免重复下载、横竖屏切换webview的内容

#### 3.2 工具集

| 工具               | 问题                                                         | 能力          |
| ------------------ | ------------------------------------------------------------ | ------------- |
| wireshark          | 最专业的，所有网络性能问题的分析定位都可以查看它             | 发现+定位     |
| har+pagespeed      | 把pcap换成har，上传到http://stevesouders.com/flint/，然后根据雅虎军规，发现很多性能问题 | 发现+定位     |
| fiddler            | 主要针对HTTP，能发现HTTP的很多性能问题，还能模拟错误和延时的HTTP返回 | 发现+定位     |
| tcpdump            | 抓包工具，需要root                                           | 发现+定位     |
| traceroute         | 定位网络问题，包括就近接入、跨运营商                         | 发现+定位     |
| ARO                | 无压缩、重复下载、缓存失效等，还有雅虎军规中的其他问题       | 自动发现+定位 |
| WebP/BPG           | 图片压缩方案，前者基于webm，后者基于H.264                    | 解决          |
| SPDY/QUICK/HTTP2.0 | 网络协议，利用fasttcpopen减少握手次数，利用UDP更好地适应网络抖动 | 解决          |
| WebPageTest.org    | web应用的数据上报。提供loadtime、startrendere、speedindex、dom elements等耗时 | 发现+定位     |
| tPackageCapture    | 无root抓包                                                   | 定位          |
| ATC                | 弱网络模拟工具，窄带、延时、丢包、损坏包以及乱序包           | 发现          |

**wireshark**

**需要多次复习**
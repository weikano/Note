### 第03章-智能指针

简单的对象引用使用计数技术，但是碰到循环引用就会歇菜。智能指针时一个对象，它引用了一个实际使用的对象，能够自动的维护实际对象的引用技术。

智能指针将对象的引用计数分为强和弱两种，对象的生命周期只受强引用计数影响。此方案中，一般将有关联的对象划分为"父-子"和"子-父"。"父-子"中，"父"通过强引用计数来引用"子"对象，"子-父"中"子"通过弱引用计数来引用"父"对象。

假设A和B是"父-子"关系，则B和A就是"子-父"关系。A通过强引用计数来引用B，B通过弱引用计数来引用A。当A不再使用时，由于B是通过弱引用计数引用A，因此A的生命周期不受B的影响，可以安全释放。释放A时，A对B的强引用也会释放，因此当B不再使用时，B也会被安全释放。

另外当B想要使用A时，必须将对象A的弱引用计数升级为强引用计数，然后才能使用。如果B不能，那么说明A已经释放。

Android系统提供了三种智能指针：LightPointer, StrongPointer, WeakPointer。

#### 3.1 轻量级指针

要使用轻量级指针，那么类必须从LightRefBase继承下来。

##### 3.1.1 实现原理分析

构造函数中初始化m_ptr，调用incStrong来增加引用计数；析构函数中通过decStrong来减少引用计数或者释放内存。其中IncStrong和decStrong都是继承自LightRefBase。

#### 3.2 强指针和弱指针

如果一个类的对象需要支持强指针和弱指针，必须从RefBase类继承下来。强弱指针是配合在一起使用的。

RefBase跟LightRefBase一样提供了incStrong和decStrong来维护它所引用的对象的引用技术，但是它不是直接通过一个整数，而是weakref_impl对象。weakref_impl同时提供了强引用和弱引用计数。

weakref_impl的mFlags是一个标志，用来描述对象的生命周期控制方式。0表示之后强引用计数印象; OBJECT_LIFETIME_WEAK表示同时受强弱引用计数影响；OBJECT_LIFETIME_FOREVER表示不受二者影响。
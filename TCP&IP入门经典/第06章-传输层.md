### 第06章-传输层

#### 6.1 传输层简介

#### 6.2 传输层概念

##### 6.2.1 面向连接和无连接的协议

- 面向连接的协议：在通信计算机之间建立并维护一个连接，并在通信过程中监视连接的状态。每个通过网络传输的数据包都会收到一个确认，发送端计算机会记录状态信息来确保每个数据包都被正确接收，并且在需要时会重发数据。传输完毕后，发送端和接收端会以适当方式关闭连接。
- 无连接协议：单向方式向目的地发送数据，不需要传输状态

##### 6.2.2 端口和套接字

在TCP/IP系统中，应用程序通过端口号向传输层指定目的地。**端口是一个预定义的内部地址，充当从应用程序到传输层或从传输层到应用程序之间的通路**。

套接字是一个用IP地址和端口号组成的地址。

##### 6.2.3 多路复用/多路分解

多路复用：把多个来源的数据合并成一个输出。

多路分解：把从一个来源接收的数据发送到多个输出。

**多路复用和多路分解的关键在于套接字地址，为特定计算机上（IP地址）的特定应用程序（端口号）提供了唯一标识符**。

#### 6.3 理解TCP和UDP

##### 6.3.1 TCP

- 面向流的处理：可以一个字节一个字节的接收数据。TCP把接收到的数据组成长度不定的端，传递给网际层
- 重新排序：TCP能够将错误顺序的数据重新排序来回复原始顺序
- 流量控制：确保数据传输不会超过目的计算机接收数据的能力
- 优先级与安全：很多TCP没有实现
- 适当的关闭：确保在连接被关闭前所有数据都被发送和接收了

###### 1. TCP数据格式

- 源端口（16位）
- 目的端口（16位）
- 序列号（32位）：SYN标记不为1时，这是当前数据分段第一个字节的序列号；SYN值为1时，这个值为初始序列号（ISN），用于对序列号进行同步。如果SYN设置为1，这时第一个字节的序列号比这个字段中的值大1，即ISN+1
- 确认号（32位）：用于确认已经接收到的数据分段，值为接收计算机即将接收的下一个序列号，即上一个接收到的字节的序列号加1
- 数据偏移（4位）：表示报头的长度，即告诉接收端数据从何开始，以一个32位的整数值来表示
- 保留（6位）：以后使用，当前全为0
- 控制标记（分别占用1位）：表示数据分段的特殊信息
- URG：为1时表示当前数据段是紧急的，一会让紧急指针字段的值很重要
- ACK：为1时表示确认号很重要
- PSH：为1时让TCP把目前发送的所有数据都通过管道传递给接收应用程序
- RST：为1时重置连接
- SYN：为1时表示序列号将被同步，说明这是一个连接的开始
- FIN：为1时表示已经买诶呦数据需要发送了，用于关闭一个连接
- 窗口（16位）：用于流量控制的参数。这个字段定义了在发送端计算机无需进一步确认即可发送数据的序列号范围，这个序列号范围超过了最后一个确认的序列号
- 校验和（16位）：用于检验数据分段的完整性
- 紧急指针（16位）：指向紧急标记信息开始的序列号
- 选项：指定一些可选设置中的某一项小设置
- 填充：额外填充为0，以确保从32位的边界开始
- 数据：分段中传输的数据

###### 2. TCP连接

###### 3. 建立连接

>计算机A发送一个数据分段：
>
>1. A发送：SYN=1，ACK=0，序列号=X（计算机A的ISN）
>2. B接收后返回A：SYN=1，ACK=1，序列号=Y（计算机B的ISN），确认号=M+1（M为从A中接收到的最后一个序列号）
>3. A接收到B的返回后发送确认信息给B：SYN=0，ACK=1，序列号=序列中的下一个号码，确认号=N+1（N是从B接收到的最后一个序列号）

###### 4. TCP流量控制

窗口字段用来控制流量，避免发送端数据发送太快，从而使接收端有时间处理接收到的数据，避免数据丢失。

滑动窗口：接收端利用窗口字段定义一个超过最后已确认序列号的序列号窗口，在这个范围内的序列号才允许发送端计算机发送。发送端没有接收到下一个确认消息前不能发送超过这个窗口的序列号数据

###### 5. 关闭连接

>1. A发送：FIN=1，之后应用进入结束-等待状态。这时A能继续接收数据分段，并处理在序列中的数据分段，但不再从应用程序中接收额外的数据
>2. B接收到FIN时，返回FIN的确认消息，然后发送剩余的数据分段，并通知本地应用已经接收到FIN消息。
>3. B向A发送一个FIN数据分段，A返回确认消息，连接就关闭了。

##### 6.3.2 UDP

UDP只包含有限的错误校验功能：

- UDP数据报中包含校验和，接收端能检验数据的完整性。可选，能被接收端禁用以加快数据的处理
- UDP数据报中有一个伪报头，包含数据报的目的地址，可以检测错误传输。
- UDP接收模块接收到一个发送给未定义或未激活的UDP端口时，会返回ICMP消息，通知来源端这个端口不可达。

UDP头包含4个16位字段：

- 源端口：可选。如果发送端应用没有包含其端口，全为0，这时为单向消息
- 目的端口
- 长度：包含了报头和数据报的长度。UDP报头长度为8字节，所以最小值为8
- 校验和：基于伪报头、UDP报头、UDP数据和填充的0计算。源计算机生成，目的计算机进行校验

#### 6.4 防火墙和端口

阻断对特定TCP和UDP端口的访问。可以阻止外部用户访问网络内部的服务，也可以组织内部用户访问网络外部的服务。


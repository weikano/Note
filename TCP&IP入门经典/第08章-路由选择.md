### 第08章-路由选择

#### 8.1 TCP/IP中的路由选择

##### 8.1.1 什么是路由器

> 具有两块网络适配器的工具

IP地址是属于适配器的，而不是属于计算机的。

- 路由器的端口（适配器）可能超过两个：同时连接两个以上的网络
- 路由器连接起来的网络还分别与其他网络相连，必须具有某种策略把数据转发到这些非直连网络上
- 路由器网络提供了冗余的路径，路由器必须能够以某种方式决定使用哪个路径

##### 8.1.2 路由选择过程

##### 8.1.3 路由表的概念

> 将目的网络IP映射到下一跳的IP地址（只需要网络ID），即数据报通往目的网络的下一站。路由表会区分直连到路由器本身的网络还是通过其他路由间接连接的网络。下一跳可以是目的网络，也可以是下游路由器。路由器端口是指转发数据的路由器端口。
>
> 简单的路由表：
>
> | 目的       | 下一跳            | 路由器端口 |
> | ---------- | ----------------- | ---------- |
> | 129.14.0.0 | direct connection | 1          |
> | 150.27.0.0 | 131.100.18.6      | 3          |

##### 8.1.4 IP转发

主机的路由表可能只包含两行：

- 用于本地网络
- 用于默认路由，处理不能在本地网络上传输的数据包

如果目的地址不在本地网络上，主机会把数据包发送到路由器。IP报头只包含了目的IP和端口，没有包含传输数据报的每台中间路由器的地址。IP转发过程并不会在IP报头上写入路由器地址，而是由主机把数据报和路由IP地址乡下传递给网络访问层，该层的协议会使用一个独立的查询过程把数据封装到一个帧中，通过本地网络传输给路由器。过程如下：

1. 一台主机准备发送一个IP数据报，它查看自己的路由表
2. 如果不能在本地网络上发送，主机从路由表中提取与目的地址相关联的路由器IP地址。路由器IP地址被ARP解析为MAC地址
3. 数据报和要接收数据报的路由器的物理地址一起被传递给网络访问层
4. 路由器的网络适配器接收这个帧，因为物理地址匹配
5. 路由器拆分帧，把数据报传递给网际层
6. 路由器查看数据报的IP地址。如果匹配路由器自己的IP地址，表示数据报是发送给路由器本身的；否则查看路由表，找到与数据报目的IP相关的路由器，转发这个数据报
7. 如果不能把数据报发送给与路由器相连接的任何网段，路由器就把数据报发送给另一台路由器，上述过程从1开始重复进行，直到最后一个路由器能够把数据传输给目的主机

##### 8.1.5 直接和间接路由

路由器了解间接路由的两种方式：系统管理员（静态路由）和其他路由器（动态路由）

##### 8.1.6 动态路由算法

路由协议分为下列两种：

###### 1. 距离矢量路由

> 让路由器之间所需的通信量最少，让路由表中必须保留的数据最少。网段之间的距离以数据报在两个网段之间传输必须经过的路由器数量来表示，这个距离称为跳数。工作方式如下；
>
> 1. 路由器A初始化时，将直连的网段写入路由表，跳数设置为0
> 2. A从邻居路由器中收到报告后，按照如下方法将新路由信息写入自己的路由表：
>    - 如果B的信息中包含一个A目前还不知道的网段，A就把这个网段添加到自己的路由表中。去往这个新网段的路由就是B。对A来说，这个新网段的跳数为B到该网段的跳数+1
>    - 如果B的信息中包含的网段已经在A中，A会把B的跳数加1，将该值与路由表中的值做比较。如果跳数更少，就替换路由为B，跳数为B的跳数+1
>    - 如果B的网段跳数比A中路由表中的跳数更大，则不会被使用

###### 2. 链路状态路由

> 每个路由器都尝试建立关于网络拓扑的内部映射。每台路由定期向网络发送状态信息，列出了自己直连的其他路由器及链路状态。路由器利用其他路由器的状态信息简历网络拓扑的映射，发送数据报时会根据最有路径选择。

#### 8.2 复杂网络上的路由

#### 8.3 内部路由器

##### 8.3.1 路由信息协议（RIP）

距离适量协议，通过跳数判断到达目的地的最佳路由。

RIP的参与者被划分为主动和被动两种。

- 主动RIP节点：参与正常的矢量距离数据交换的路由器，会把自己的路由表发送给其他路由器，并且接收来自其他路由器的更新信息。
- 被动RIP节点：不传播自己的路由表，只接收更新信息。典型的为普通计算机。
- RIP路由器没30秒广播一次，RIP设置了从第一台路由器到达目的地的最大跳数限制（15）

##### 8.3.2 开放最短路径优先（OSPF）

一种链路状态协议。OSPF路由器中的每台路由器都指定一个路由ID，通常是与路由器相关联的最大IP地址。每台路由器把网络组织为一个树形，自己位于树的根部。这个网络树称为最短路径树（SPT），通过网络的路径就对应于SPT的路径。**路由器计算每个路由的开销，开销度量包含跳数和其他一些因素，比如链路速度和链路的可靠性**。

#### 8.4 外部路由器BGP



